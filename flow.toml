version = 1
name = "seq"

[flow]
deploy_task = "deploy"

[release]
default = "registry"
versioning = "calver"

[release.registry]
url = "https://myflow.sh"
package = "seq"
bins = ["seq", "seqd"]
default_bin = "seq"
token_env = "FLOW_REGISTRY_TOKEN"
latest = true

[[tasks]]
name = "build"
command = "sh ./cli/cpp/run.sh build"
description = "Build seq CLI/daemon (includes seqmem dylib)"

[[tasks]]
name = "release-registry-stage"
command = "sh -lc \"sh ./cli/cpp/run.sh build && mkdir -p target/release && cp ./cli/cpp/out/bin/seq ./cli/cpp/out/bin/seqd target/release/\""
description = "Build seq/seqd and stage binaries to target/release for registry publishing."

[[tasks]]
name = "release-registry-publish"
command = "sh -lc \"f release registry --no-build\""
description = "Publish staged seq/seqd binaries to myflow registry."

[[tasks]]
name = "daemon-restart"
command = "f daemon restart seqd"
description = "Restart seqd via Flow daemon manager"

[[tasks]]
name = "deploy"
command = "sh ./cli/cpp/run.sh deploy"
description = "Build seq and restart seqd"

[[tasks]]
name = "app-state"
command = "sh -lc \"/Users/nikiv/code/seq/cli/cpp/out/bin/seq app-state\""
description = "Dump seqd cached frontmost/previous app (avoid PATH conflict with /usr/bin/seq)"

[[tasks]]
name = "accessibility-prompt"
command = "sh -lc \"/Users/nikiv/code/seq/cli/cpp/out/bin/seq accessibility-prompt\""
description = "Trigger Accessibility permission prompt for seq (needed for Cmd-Tab injection)"

[[tasks]]
name = "test"
command = "sh ./cli/cpp/run.sh test"
description = "Perf smoke tests for seqd + memory engine"

[[tasks]]
name = "watch-open-app-toggle"
command = "sh -lc \"tail -f $HOME/repos/ClickHouse/ClickHouse/user_files/seq_mem.jsonl | rg --line-buffered 'cli\\\\.open_app_toggle\\\\.action'\""
description = "Tail open-app-toggle decisions (cli.open_app_toggle.action) from seq_mem.jsonl"

[[tasks]]
name = "watch-open-app-toggle-debug"
command = "sh -lc \"tail -f $HOME/repos/ClickHouse/ClickHouse/user_files/seq_mem.jsonl | rg --line-buffered 'cli\\\\.open_app_toggle\\\\.action|seqd\\\\.open_app_toggle\\\\.diag|app\\\\.activate'\""
description = "Tail app-toggle decisions + daemon diag + app.activate from seq_mem.jsonl"

[[tasks]]
name = "watch-open-app-toggle-rule"
command = "sh -lc \"tail -f $HOME/repos/ClickHouse/ClickHouse/user_files/seq_mem.jsonl | python3 tools/open_app_toggle_rule.py\""
description = "Rule: for each decision=open_prev, expect app.activate(prev) soon after"

[[tasks]]
name = "km-parallel-scout"
command = "python3 tools/km_parallel_scout.py --limit 50"
description = "Scan kar/config.ts + KM macro DB for macros that could benefit from seq parallel execution"

[[tasks]]
name = "import-km-arc"
command = "python3 tools/import_km_arc_macros.py"
description = "Import KM arc:* macros into seq.macros.local.yaml (Spaces menu + keystrokes)"

[[tasks]]
name = "import-km-arc-deploy"
command = "sh -lc \"python3 tools/import_km_arc_macros.py && sh ./cli/cpp/run.sh deploy\""
description = "Import KM arc:* macros then deploy (restart seqd)"

[[tasks]]
name = "dump-open-app-toggle-debug"
command = "sh -lc \"/Users/nikiv/code/seq/cli/cpp/out/bin/seq app-state; echo '---'; tail -n 200 $HOME/repos/ClickHouse/ClickHouse/user_files/seq_mem.jsonl | rg 'cli\\\\.open_app_toggle\\\\.action|seqd\\\\.open_app_toggle\\\\.diag|app\\\\.activate' | tail -n 80\""
description = "Snapshot current app-state + recent open-app-toggle related events"

[[tasks]]
name = "tail-logs"
command = "python3 tools/tail_all_logs.py --last 200"
description = "Tail both seq_trace.jsonl + seq_mem.jsonl (human readable)"

[[tasks]]
name = "tail-logs-json"
command = "python3 tools/tail_all_logs.py --last 200 --json"
description = "Tail both logs as JSON objects (easy to paste)"

[[tasks]]
name = "watch-logs"
command = "sh -lc \"echo 'READY watch-logs'; python3 tools/tail_all_logs.py --last 0 --follow\""
description = "Follow both logs from now (starts empty; human readable)"

[[tasks]]
name = "watch-logs-toggle"
command = "sh -lc \"echo 'READY watch-logs-toggle'; python3 tools/tail_all_logs.py --last 0 --follow --grep 'open_app_toggle|app\\\\.activate'\""
description = "Follow app toggle + app.activate from now (starts empty)"

[[tasks]]
name = "watch-logs-json"
command = "sh -lc \"echo 'READY watch-logs-json'; python3 tools/tail_all_logs.py --last 0 --follow --json\""
description = "Follow both logs from now as JSON objects (starts empty; pasteable)"

[[tasks]]
name = "watch-logs-toggle-json"
command = "sh -lc \"echo 'READY watch-logs-toggle-json'; python3 tools/tail_all_logs.py --last 0 --follow --json --grep 'open_app_toggle|app\\\\.activate'\""
description = "Follow app toggle + app.activate from now as JSON objects (starts empty)"

[[tasks]]
name = "watch-arc"
command = "sh -lc \"echo 'READY watch-arc'; python3 tools/tail_all_logs.py --last 0 --follow --grep 'seqd\\\\.run|menu\\\\.select|AX_(STATUS|PROMPT)|open_url\\\\.activate_app'\""
description = "Follow Arc-related automation (seqd.run + menu.select + open_url.activate_app)"

[[tasks]]
name = "watch-arc-json"
command = "sh -lc \"echo 'READY watch-arc-json'; python3 tools/tail_all_logs.py --last 0 --follow --json --grep 'seqd\\\\.run|menu\\\\.select|AX_(STATUS|PROMPT)|open_url\\\\.activate_app'\""
description = "Follow Arc-related automation as JSON objects (pasteable)"

[[tasks]]
name = "scrape-health"
command = "sh -lc \"curl -fsS ${SEQ_SCRAPER_BASE_URL:-http://127.0.0.1:7444}/health | python3 -m json.tool\""
description = "Check scraper daemon/API health (used by teach commands)."

[[tasks]]
name = "teach-dep"
command = "python3 tools/teach_deps.py dep \"$@\""
description = "Generate a dependency skill by scraping official docs via the always-on scraper."

[[tasks]]
name = "teach-auto"
command = "python3 tools/teach_deps.py auto \"$@\""
description = "Auto-discover dependencies in this repo and generate skills using scraper jobs."

[[tasks]]
name = "teach-url"
command = "python3 tools/teach_deps.py url \"$@\""
description = "Generate a skill from one or more URLs via scraper jobs."

[[tasks]]
name = "teach-logs"
command = "sh -lc \"tail -f ${SEQ_CH_MEM_PATH:-$HOME/repos/ClickHouse/ClickHouse/user_files/seq_mem.jsonl} | rg --line-buffered 'teach\\\\.'\""
description = "Tail teach.* scraper skill events from seq_mem.jsonl."

[[tasks]]
name = "kar-uc-build-bridge"
command = "sh -lc \"cd $HOME/repos/pqrs-org/Karabiner-Elements-user-command-receiver && make build-bridge-release\""
description = "Build release seq-user-command-bridge in Karabiner user-command receiver repo."

[[tasks]]
name = "kar-uc-rebuild-restart"
command = "sh -lc \"cd $HOME/repos/pqrs-org/Karabiner-Elements-user-command-receiver && make build-bridge-release && cd $HOME/code/seq && python3 tools/kar_uc_launchd.py restart\""
description = "Always rebuild release bridge and kickstart launchd agent."

[[tasks]]
name = "kar-uc-run-bridge"
command = "sh -lc \"export SEQ_USER_COMMAND_SOCKET_PATH=\\\"/Library/Application Support/org.pqrs/tmp/user/$(id -u)/user_command_receiver.sock\\\"; export SEQ_BRIDGE_HIGH_PRIORITY=${SEQ_BRIDGE_HIGH_PRIORITY:-1}; cd $HOME/repos/pqrs-org/Karabiner-Elements-user-command-receiver && make run-bridge-release\""
description = "Run release seq-user-command-bridge (high-priority by default) for low-latency forwarding."

[[tasks]]
name = "kar-uc-run-bridge-debug"
command = "sh -lc \"export SEQ_USER_COMMAND_SOCKET_PATH=\\\"/Library/Application Support/org.pqrs/tmp/user/$(id -u)/user_command_receiver.sock\\\"; cd $HOME/repos/pqrs-org/Karabiner-Elements-user-command-receiver && make run-bridge\""
description = "Run debug seq-user-command-bridge (swift run) for development."

[[tasks]]
name = "kar-uc-launchd-install"
command = "python3 tools/kar_uc_launchd.py install --build-if-missing"
description = "Install+load always-on launchd agent for release seq-user-command-bridge."

[[tasks]]
name = "kar-uc-launchd-restart"
command = "python3 tools/kar_uc_launchd.py restart --build-if-missing"
description = "Restart launchd bridge agent after rebuilding release binary."

[[tasks]]
name = "kar-uc-launchd-stop"
command = "python3 tools/kar_uc_launchd.py stop"
description = "Stop launchd bridge agent."

[[tasks]]
name = "kar-uc-launchd-status"
command = "python3 tools/kar_uc_launchd.py status"
description = "Show launchd bridge agent status."

[[tasks]]
name = "kar-uc-launchd-uninstall"
command = "python3 tools/kar_uc_launchd.py uninstall"
description = "Unload and remove launchd bridge agent plist."

[[tasks]]
name = "kar-uc-launchd-logs"
command = "sh -lc \"tail -n 80 -f $HOME/code/seq/cli/cpp/out/logs/kar_uc_bridge.stderr.log\""
description = "Tail bridge launchd stderr log."

[[tasks]]
name = "kar-uc-send"
command = "python3 tools/kar_user_command_send.py \"$@\""
description = "Send a JSON payload to Karabiner user-command receiver socket."

[[tasks]]
name = "kar-uc-smoke"
command = "python3 tools/kar_user_command_smoke.py \"$@\""
description = "Smoke test bridge forwarding with a mock seqd dgram socket."

[[tasks]]
name = "kar-uc-bench"
command = "python3 tools/kar_user_command_latency_bench.py \"$@\""
description = "Benchmark direct seqd dgram vs send_user_command bridge overhead."

[[tasks]]
name = "kar-uc-e2e-ab"
command = "python3 tools/kar_user_command_e2e_ab.py \"$@\""
description = "A/B benchmark full software flow: legacy shell path vs send_user_command path."

[[tasks]]
name = "kar-uc-floor-check"
command = "python3 tools/kar_user_command_floor_check.py \"$@\""
description = "Clean-room floor harness: system gate + bridge restart + repeated E2E + transport summary."

[[tasks]]
name = "kar-uc-system-check"
command = "sh -lc \"cd $HOME/repos/pqrs-org/Karabiner-Elements-user-command-receiver && make run-system-check\""
description = "Check system pressure and readiness for clean latency testing (READY/NOT_READY verdict)."

[[tasks]]
name = "kar-uc-system-check-report"
command = "sh -lc \"cd $HOME/repos/pqrs-org/Karabiner-Elements-user-command-receiver && swift run kar-uc-system-check || true\""
description = "Report system pressure/readiness without failing task status."

[[tasks]]
name = "zvec-server"
command = "sh ./cli/zvec/run.sh start"
description = "Start zvec vector search server (HTTP :8900)"
daemon = true

[[tasks]]
name = "mac-kg-index"
command = "python3 tools/mac_knowledge.py index \"$@\""
description = "Index local macOS files/metadata into seq mac knowledge DB (SQLite + FTS, optional zvec upsert)."

[[tasks]]
name = "mac-kg-watch"
command = "python3 tools/mac_knowledge.py watch \"$@\""
description = "Continuously refresh mac knowledge DB with fast incremental scans."

[[tasks]]
name = "mac-kg-search"
command = "python3 tools/mac_knowledge.py search \"$@\""
description = "Search local mac knowledge DB (lexical, optional --vector via zvec)."

[[tasks]]
name = "mac-kg-who-watches"
command = "python3 tools/mac_knowledge.py who-watches \"$@\""
description = "Show inferred watchers/dependencies for a file path (e.g. kar config.ts)."

[[tasks]]
name = "mac-kg-stats"
command = "python3 tools/mac_knowledge.py stats \"$@\""
description = "Show mac knowledge DB stats."
